#!/usr/bin/env bash

#maintenance mode
wget http://169.254.169.254/latest/user-data
if [ $? = 0 ]; then
  USER_DATA=$(cat user-data)
  if [ ${USER_DATA} = "maintenance_mode" ]; then
    exit 0
  fi
fi

workingDir="/opt/codefresh"
logsDir="${workingDir}/logs"

mkdir -p ${logsDir}

# run wizard
docker pull codefresh/enterprise-installer:master
docker run --name wizard --restart="always" -d -p 8080:9000 -v /opt/codefresh:/opt/codefresh codefresh/enterprise-installer:master

#start bootstrap
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/images
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/bootstraper
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/cf-helm-ami
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/installer
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/flannel.yml
wget https://raw.githubusercontent.com/codefresh-io/k8s-single-node-installer/master/local-storage.yml

chmod +x bootstraper
chmod +x installer
chmod +x cf-helm-ami

# install and run k8s
EXTERNAL=true ./installer | tee >> ${logsDir}/installer.log
mkdir /root/.kube && cp /etc/kubernetes/admin.conf /root/.kube/config

export KUBECONFIG=/root/.kube/config

# run bootstraper
nohup ./bootstraper | tee >> ${logsDir}/bootstraper.log &

# run helm-updater
nohup ./cf-helm-ami | tee >> ${logsDir}/cf-helm.log &

# add to rc.local cf-helm-ami
cat << EOF > /etc/rc.local
#!/bin/sh -e
nohup ${workingDir}/cf-helm-ami | tee >> ${logsDir}/cf-helm.log &
EOF